{% extends "base.html" %}

{% block title %}Panel de Coordinador - Sistema de Optimización de Rutas{% endblock %}

{% block page_title %}Panel de Coordinador{% endblock %}

{% block sidebar_items %}
<li class="nav-item">
    <a href="{{ url_for('coordinator_dashboard') }}" class="nav-link active">
        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
    </a>
</li>
<li class="nav-item">
    <a href="{{ url_for('coordinator_view_routes') }}" class="nav-link">
        <i class="fas fa-route me-2"></i> Rutas
    </a>
</li>
{% endblock %}

{% block content %}
<!-- Encabezado con botones de reporte -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800">Panel de Coordinador</h1>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" onclick="previewReport('coordinator')">
            <i class="fas fa-eye me-2"></i>Vista Previa
        </button>
        <button type="button" class="btn btn-primary" onclick="downloadReport('coordinator')">
            <i class="fas fa-file-pdf me-2"></i>Reporte PDF
        </button>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-cog me-2"></i>Opciones
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-2"></i>Exportar a Excel
                    </a></li>
                <li><a class="dropdown-item" href="#" onclick="scheduleReport()">
                        <i class="fas fa-clock me-2"></i>Programar Reporte
                    </a></li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#" onclick="shareReport()">
                        <i class="fas fa-share me-2"></i>Compartir
                    </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Métricas principales -->
<div class="row">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Rutas Completadas</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ completed_routes }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-map-marked-alt"></i> Recorridos Completados con Mapas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Ruta</th>
                                    <th>Conductor</th>
                                    <th>Vehículo</th>
                                    <th>Completado</th>
                                    <th>Combustible</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for completion in recent_completions %}
                                <tr>
                                    <td>{{ completion.route.name }}</td>
                                    <td>{{ completion.driver.first_name }} {{ completion.driver.last_name }}</td>
                                    <td>{{ completion.vehicle.brand }} {{ completion.vehicle.model }}</td>
                                    <td>{{ completion.completed_at|datetime_format('%d/%m/%Y %H:%M') }}</td>
                                    <td>
                                        <span
                                            class="badge bg-{% if completion.fuel_consumption > 0 %}warning{% elif completion.fuel_consumption < 0 %}success{% else %}secondary{% endif %}">
                                            {% if completion.fuel_consumption > 0 %}
                                            -{{ completion.fuel_consumption }}/4
                                            {% elif completion.fuel_consumption < 0 %} +{{
                                                abs(completion.fuel_consumption) }}/4 {% else %} Sin cambio {% endif %}
                                                </span>
                                    </td>
                                    <td>
                                        {% if completion.track_data %}
                                        <a href="{{ url_for('view_completion_map', completion_id=completion.id) }}"
                                            class="btn btn-sm btn-primary">
                                            <i class="fas fa-map"></i> Ver Recorrido
                                        </a>
                                        {% else %}
                                        <span class="text-muted">Sin datos</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">En Progreso</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ in_progress_routes }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total Rutas</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_routes }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-route fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Choferes Activos</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_drivers }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-hard-hat fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Métricas de combustible y rendimiento -->
<div class="row">
    <!-- Resumen de combustible -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-gas-pump me-2"></i>Resumen de Combustible
                </h6>
            </div>
            <div class="card-body">
                <!-- Consumo del día -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-sm font-weight-bold">Consumo Hoy</span>
                        <span class="text-sm font-weight-bold text-danger" id="todayFuel">0 L</span>
                    </div>
                    <div class="progress progress-sm mb-1">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: 0%" id="todayFuelBar">
                        </div>
                    </div>
                    <small class="text-muted">Meta diaria: 20L</small>
                </div>

                <!-- Eficiencia promedio -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-sm font-weight-bold">Eficiencia Promedio</span>
                        <span class="text-sm font-weight-bold text-success" id="avgEfficiency">0 km/L</span>
                    </div>
                </div>

                <!-- Ahorro vs mes anterior -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-sm font-weight-bold">Vs. Mes Anterior</span>
                        <span class="text-sm font-weight-bold" id="fuelSavings">
                            <i class="fas fa-arrow-down text-success"></i> 5%
                        </span>
                    </div>
                </div>

                <hr>

                <!-- Alertas de combustible -->
                <h6 class="text-sm font-weight-bold mb-3">Alertas</h6>
                <div id="fuelAlerts">
                    <div class="alert alert-success alert-sm">
                        <i class="fas fa-check-circle me-2"></i>
                        <small>Todos los vehículos con combustible suficiente</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rendimiento por chofer -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-bar me-2"></i>Rendimiento por Chofer - Semana Actual
                </h6>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-period="week">Semana</button>
                    <button type="button" class="btn btn-outline-primary" data-period="month">Mes</button>
                    <button type="button" class="btn btn-outline-primary" data-period="quarter">Trimestre</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="driverPerformanceChart" width="400" height="200"></canvas>
                <div class="mt-3">
                    <div class="table-responsive">
                        <table class="table table-sm" id="driverPerformanceTable">
                            <thead>
                                <tr>
                                    <th>Chofer</th>
                                    <th>Rutas</th>
                                    <th>Combustible</th>
                                    <th>Eficiencia</th>
                                    <th>Puntaje</th>
                                </tr>
                            </thead>
                            <tbody id="driverPerformanceBody">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <small>Cargando datos...</small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Análisis detallado por categoría -->
<div class="row">
    <!-- Consumo por vehículo -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-truck me-2"></i>Consumo por Vehículo
                </h6>
            </div>
            <div class="card-body">
                <canvas id="vehicleFuelChart" width="400" height="250"></canvas>
                <div class="mt-3">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Vehículo</th>
                                    <th>Consumo</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="vehicleFuelTableBody">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        <small>Cargando datos...</small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Eficiencia por ruta -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-route me-2"></i>Eficiencia por Ruta
                </h6>
            </div>
            <div class="card-body">
                <canvas id="routeEfficiencyChart" width="400" height="250"></canvas>
                <div class="mt-3">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Ruta</th>
                                    <th>Consumo Prom.</th>
                                    <th>Completadas</th>
                                </tr>
                            </thead>
                            <tbody id="routeEfficiencyTableBody">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        <small>Cargando datos...</small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tendencia semanal -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-line me-2"></i>Tendencia Semanal
                </h6>
            </div>
            <div class="card-body">
                <canvas id="weeklyTrendChart" width="400" height="250"></canvas>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="text-xs text-muted text-uppercase mb-1">Promedio Diario</div>
                            <div class="h6 mb-0" id="dailyAvg">0 L</div>
                        </div>
                        <div class="col-6">
                            <div class="text-xs text-muted text-uppercase mb-1">Mejor Día</div>
                            <div class="h6 mb-0 text-success" id="bestDay">Lun</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Completados recientes con detalles de combustible -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-list-check me-2"></i>Completados Recientes con Detalles de Combustible
                </h6>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" id="todayBtn">Hoy</button>
                    <button type="button" class="btn btn-outline-primary" id="weekBtn">Esta Semana</button>
                    <button type="button" class="btn btn-outline-primary" id="monthBtn">Este Mes</button>
                </div>
            </div>
            <div class="card-body">
                {% if recent_completions %}
                <div class="table-responsive">
                    <table class="table table-bordered" id="recentCompletionsTable">
                        <thead>
                            <tr>
                                <th>Ruta</th>
                                <th>Chofer</th>
                                <th>Vehículo</th>
                                <th>Completado</th>
                                <th>Duración</th>
                                <th>Combustible</th>
                                <th>Eficiencia</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for completion in recent_completions %}
                            <tr>
                                <td><strong>{{ completion.route.name if completion.route else 'N/A' }}</strong></td>
                                <td>{{ completion.driver.first_name + ' ' + completion.driver.last_name if
                                    completion.driver else 'N/A' }}</td>
                                <td>
                                    {% if completion.vehicle %}
                                    {{ completion.vehicle.brand }} {{ completion.vehicle.model }}<br>
                                    <small class="text-muted">{{ completion.vehicle.plate_number }}</small>
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </td>
                                <td>{{ completion.completed_at|datetime_format if completion.completed_at else 'En
                                    progreso' }}</td>
                                <td>
                                    {% if completion.started_at and completion.completed_at %}
                                    {% set duration = (completion.completed_at - completion.started_at).total_seconds()
                                    / 3600 %}
                                    {{ "%.1f h"|format(duration) }}
                                    {% else %}
                                    --
                                    {% endif %}
                                </td>
                                <td>
                                    {% if completion.fuel_start and completion.fuel_end %}
                                    <span class="badge bg-primary">{{ completion.fuel_start }}/4</span>
                                    <i class="fas fa-arrow-right mx-1"></i>
                                    <span
                                        class="badge bg-{{ 'danger' if completion.fuel_consumption > 1 else 'success' }}">{{
                                        completion.fuel_end }}/4</span>
                                    <br><small class="text-muted">Consumo: {{ completion.fuel_consumption or 0
                                        }}/4</small>
                                    {% else %}
                                    <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if completion.fuel_consumption and completion.route and completion.route.distance
                                    %}
                                    {% set efficiency = (completion.route.distance / 1000) /
                                    (completion.fuel_consumption * 40) %}
                                    <span
                                        class="badge bg-{{ 'success' if efficiency > 10 else 'warning' if efficiency > 8 else 'danger' }}">
                                        {{ "%.1f km/L"|format(efficiency) }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">--</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if completion.status == 'completed' %}
                                    <span class="badge bg-success">Completado</span>
                                    {% elif completion.status == 'in_progress' %}
                                    <span class="badge bg-warning">En progreso</span>
                                    {% elif completion.status == 'canceled' %}
                                    <span class="badge bg-secondary">Cancelado</span>
                                    {% else %}
                                    <span class="badge bg-info">{{ completion.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-clipboard-list fa-3x text-muted"></i>
                    </div>
                    <p class="lead text-muted">No hay completados registrados aún.</p>
                    <small class="text-muted">Las rutas completadas aparecerán aquí con detalles de combustible.</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de vista previa de reporte -->
<div class="modal fade" id="reportPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-pdf me-2"></i>Vista Previa - Reporte de Coordinación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="reportPreviewContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Generando vista previa del reporte...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
                <button type="button" class="btn btn-primary" id="downloadFromPreview">
                    <i class="fas fa-download me-2"></i>Descargar PDF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para opciones adicionales -->
<div class="modal fade" id="reportOptionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>Opciones de Reporte
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Período del Reporte:</label>
                    <select class="form-select" id="reportPeriod">
                        <option value="7">Últimos 7 días</option>
                        <option value="30" selected>Últimos 30 días</option>
                        <option value="90">Últimos 90 días</option>
                        <option value="custom">Período personalizado</option>
                    </select>
                </div>

                <div class="mb-3" id="customPeriodDiv" style="display: none;">
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">Desde:</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Hasta:</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Incluir secciones:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeDrivers" checked>
                        <label class="form-check-label" for="includeDrivers">
                            Rendimiento por Chofer
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeRoutes" checked>
                        <label class="form-check-label" for="includeRoutes">
                            Análisis por Ruta
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeFuel" checked>
                        <label class="form-check-label" for="includeFuel">
                            Métricas de Combustible
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeRecommendations" checked>
                        <label class="form-check-label" for="includeRecommendations">
                            Recomendaciones
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="generateCustomReport()">
                    <i class="fas fa-file-pdf me-2"></i>Generar Reporte
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<style>
    .border-left-primary {
        border-left: 0.25rem solid #4e73df !important;
    }

    .border-left-success {
        border-left: 0.25rem solid #1cc88a !important;
    }

    .border-left-warning {
        border-left: 0.25rem solid #f6c23e !important;
    }

    .border-left-info {
        border-left: 0.25rem solid #36b9cc !important;
    }

    .text-gray-800 {
        color: #5a5c69 !important;
    }

    .text-gray-300 {
        color: #dddfeb !important;
    }

    .text-xs {
        font-size: 0.7rem;
    }

    .text-sm {
        font-size: 0.875rem;
    }

    .progress-sm {
        height: 0.5rem;
    }

    .alert-sm {
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
    }

    .performance-score {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        font-weight: bold;
        font-size: 0.9rem;
        color: white;
    }

    .score-excellent {
        background-color: #28a745;
    }

    .score-good {
        background-color: #20c997;
    }

    .score-average {
        background-color: #ffc107;
        color: #333;
    }

    .score-poor {
        background-color: #fd7e14;
    }

    .score-bad {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let driverPerformanceChart, vehicleFuelChart, routeEfficiencyChart, weeklyTrendChart;
    let currentReportType = 'coordinator';

    $(document).ready(function () {
        console.log('Inicializando dashboard coordinador con métricas de combustible...');

        // Inicializar DataTables
        if ($('#recentCompletionsTable').length) {
            $('#recentCompletionsTable').DataTable({
                language: window.dataTablesSpanish,
                order: [[3, 'desc']],
                pageLength: 10,
                columnDefs: [
                    { orderable: false, targets: [7] }
                ]
            });
        }

        // Cargar datos de métricas
        loadCoordinatorMetrics();

        // Eventos de botones de período
        $('[data-period]').click(function () {
            $('[data-period]').removeClass('active');
            $(this).addClass('active');
            const period = $(this).data('period');
            loadDriverPerformanceData(period);
        });

        // Eventos para filtros de completados
        $('#todayBtn').click(function () {
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
            // Implementar filtro por hoy
        });

        $('#weekBtn').click(function () {
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
            // Implementar filtro por semana
        });

        $('#monthBtn').click(function () {
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
            // Implementar filtro por mes
        });
    });

    function loadCoordinatorMetrics() {
        // Simular datos del coordinador
        const metricsData = {
            fuel: {
                today: 12.5,
                maxDaily: 20,
                avgEfficiency: 13.2,
                savings: -5 // negativo = ahorro
            },
            drivers: [
                { name: 'Juan Pérez', routes: 8, fuel: 15.2, efficiency: 11.8, score: 85 },
                { name: 'María González', routes: 6, fuel: 12.8, efficiency: 13.2, score: 92 },
                { name: 'Carlos López', routes: 4, fuel: 9.5, efficiency: 15.1, score: 95 },
                { name: 'Ana Rodríguez', routes: 5, fuel: 11.2, efficiency: 12.5, score: 88 }
            ],
            vehicles: [
                { plate: 'ABC-1234', consumption: 15.2, status: 'active' },
                { plate: 'DEF-5678', consumption: 12.8, status: 'active' },
                { plate: 'GHI-9012', consumption: 9.5, status: 'maintenance' }
            ],
            routes: [
                { name: 'Centro-Norte', avgConsumption: 2.1, completions: 12 },
                { name: 'Sur-Este', avgConsumption: 1.8, completions: 8 },
                { name: 'Zona Industrial', avgConsumption: 2.5, completions: 5 }
            ]
        };

        updateFuelSummary(metricsData.fuel);
        createDriverPerformanceChart(metricsData.drivers);
        createVehicleFuelChart(metricsData.vehicles);
        createRouteEfficiencyChart(metricsData.routes);
        createWeeklyTrendChart();
    }

    function updateFuelSummary(fuelData) {
        const fuelPercent = (fuelData.today / fuelData.maxDaily) * 100;

        $('#todayFuel').text(`${fuelData.today} L`);
        $('#todayFuelBar').css('width', Math.min(fuelPercent, 100) + '%');

        $('#avgEfficiency').text(`${fuelData.avgEfficiency} km/L`);

        // Actualizar indicador de ahorro
        const savingsElement = $('#fuelSavings');
        if (fuelData.savings < 0) {
            savingsElement.html(`<i class="fas fa-arrow-down text-success"></i> ${Math.abs(fuelData.savings)}%`);
        } else {
            savingsElement.html(`<i class="fas fa-arrow-up text-danger"></i> +${fuelData.savings}%`);
        }

        // Generar alertas dinámicas
        let alertsHtml = '';
        if (fuelPercent > 90) {
            alertsHtml = `<div class="alert alert-warning alert-sm">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <small>Consumo diario cerca del límite</small>
        </div>`;
        } else {
            alertsHtml = `<div class="alert alert-success alert-sm">
            <i class="fas fa-check-circle me-2"></i>
            <small>Consumo dentro del rango normal</small>
        </div>`;
        }
        $('#fuelAlerts').html(alertsHtml);
    }

    function createDriverPerformanceChart(driversData) {
        const ctx = document.getElementById('driverPerformanceChart').getContext('2d');

        if (driverPerformanceChart) {
            driverPerformanceChart.destroy();
        }

        driverPerformanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: driversData.map(d => d.name),
                datasets: [
                    {
                        label: 'Rutas Completadas',
                        data: driversData.map(d => d.routes),
                        backgroundColor: '#36b9cc',
                        yAxisID: 'y'
                    },
                    {
                        label: 'Eficiencia (km/L)',
                        data: driversData.map(d => d.efficiency),
                        backgroundColor: '#28a745',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Rutas' },
                        beginAtZero: true
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'km/L' },
                        grid: { drawOnChartArea: false },
                        beginAtZero: true
                    }
                }
            }
        });

        // Actualizar tabla de rendimiento
        let tableHtml = '';
        driversData.forEach(driver => {
            const scoreClass = getScoreClass(driver.score);
            tableHtml += `
            <tr>
                <td><strong>${driver.name}</strong></td>
                <td><span class="badge bg-primary">${driver.routes}</span></td>
                <td><span class="badge bg-danger">${driver.fuel}L</span></td>
                <td><span class="badge bg-success">${driver.efficiency} km/L</span></td>
                <td>
                    <div class="performance-score ${scoreClass}">
                        ${driver.score}
                    </div>
                </td>
            </tr>
        `;
        });
        $('#driverPerformanceBody').html(tableHtml);
    }

    function createVehicleFuelChart(vehiclesData) {
        const ctx = document.getElementById('vehicleFuelChart').getContext('2d');

        if (vehicleFuelChart) {
            vehicleFuelChart.destroy();
        }

        vehicleFuelChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: vehiclesData.map(v => v.plate),
                datasets: [{
                    data: vehiclesData.map(v => v.consumption),
                    backgroundColor: ['#dc3545', '#ffc107', '#28a745', '#17a2b8', '#6f42c1'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', display: true }
                }
            }
        });

        // Actualizar tabla de vehículos
        let tableHtml = '';
        vehiclesData.forEach(vehicle => {
            const statusBadge = vehicle.status === 'active' ?
                '<span class="badge bg-success">Activo</span>' :
                '<span class="badge bg-warning">Mantenimiento</span>';

            tableHtml += `
            <tr>
                <td><code>${vehicle.plate}</code></td>
                <td><span class="badge bg-danger">${vehicle.consumption}L</span></td>
                <td>${statusBadge}</td>
            </tr>
        `;
        });
        $('#vehicleFuelTableBody').html(tableHtml);
    }

    function createRouteEfficiencyChart(routesData) {
        const ctx = document.getElementById('routeEfficiencyChart').getContext('2d');

        if (routeEfficiencyChart) {
            routeEfficiencyChart.destroy();
        }

        routeEfficiencyChart = new Chart(ctx, {
            type: 'polarArea',
            data: {
                labels: routesData.map(r => r.name),
                datasets: [{
                    data: routesData.map(r => r.avgConsumption),
                    backgroundColor: ['#e74a3b', '#f39c12', '#2ecc71'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Actualizar tabla de rutas
        let tableHtml = '';
        routesData.forEach(route => {
            tableHtml += `
            <tr>
                <td><strong>${route.name}</strong></td>
                <td><span class="badge bg-info">${route.avgConsumption}L</span></td>
                <td><span class="badge bg-secondary">${route.completions}</span></td>
            </tr>
        `;
        });
        $('#routeEfficiencyTableBody').html(tableHtml);
    }

    function createWeeklyTrendChart() {
        const ctx = document.getElementById('weeklyTrendChart').getContext('2d');

        if (weeklyTrendChart) {
            weeklyTrendChart.destroy();
        }

        const weekData = {
            labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
            consumption: [8.2, 12.5, 15.1, 9.8, 14.2, 6.5, 4.3]
        };

        weeklyTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: weekData.labels,
                datasets: [{
                    label: 'Consumo Diario (L)',
                    data: weekData.consumption,
                    borderColor: '#4e73df',
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Litros' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // Actualizar estadísticas semanales
        const avgDaily = weekData.consumption.reduce((a, b) => a + b, 0) / weekData.consumption.length;
        const minIndex = weekData.consumption.indexOf(Math.min(...weekData.consumption));

        $('#dailyAvg').text(`${avgDaily.toFixed(1)} L`);
        $('#bestDay').text(weekData.labels[minIndex]);
    }

    function getScoreClass(score) {
        if (score >= 95) return 'score-excellent';
        if (score >= 85) return 'score-good';
        if (score >= 70) return 'score-average';
        if (score >= 60) return 'score-poor';
        return 'score-bad';
    }

    function loadDriverPerformanceData(period) {
        console.log(`Cargando datos de rendimiento para: ${period}`);
        // Aquí iría la lógica para hacer una llamada AJAX y actualizar los datos
    }

    // ==================== FUNCIONES PARA REPORTES PDF ====================

    function previewReport(reportType) {
        currentReportType = reportType;

        // Mostrar modal con loading
        $('#reportPreviewModal').modal('show');
        $('#reportPreviewContent').html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3">Generando vista previa del reporte...</p>
            <small class="text-muted">Esto puede tomar unos segundos</small>
        </div>
    `);

        // Hacer llamada a la API de preview
        $.get(`/api/report/preview/${reportType}`)
            .done(function (data) {
                renderCoordinatorReportPreview(data);
            })
            .fail(function (xhr) {
                let errorMsg = 'Error al cargar vista previa';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMsg = response.error || errorMsg;
                } catch (e) { }

                $('#reportPreviewContent').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${errorMsg}
                    <br><small>Intenta generar el reporte de nuevo o contacta al administrador.</small>
                </div>
            `);
            });
    }

    function renderCoordinatorReportPreview(data) {
        const content = `
        <div class="row">
            <!-- Información del reporte -->
            <div class="col-12 mb-3">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Información del Reporte de Coordinación
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Generado por:</strong> ${data.user}<br>
                                <strong>Fecha:</strong> ${new Date(data.generated_at).toLocaleString()}<br>
                                <strong>Tipo:</strong> Reporte de Coordinación
                            </div>
                            <div class="col-md-6">
                                <strong>Período:</strong> Últimos 30 días<br>
                                <strong>Choferes analizados:</strong> ${data.summary.total_drivers}<br>
                                <strong>Rutas evaluadas:</strong> ${data.summary.total_routes}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Métricas principales -->
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">Métricas Principales</h6>
                    </div>
                    <div class="card-body text-center">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="h3 text-success">${data.metrics.completed_routes || 0}</div>
                                <small class="text-muted">Rutas Completadas</small>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="h3 text-warning">${data.metrics.in_progress_routes || 0}</div>
                                <small class="text-muted">En Progreso</small>
                            </div>
                            <div class="col-12">
                                <div class="h3 text-info">${data.metrics.total_drivers || 0}</div>
                                <small class="text-muted">Choferes Activos</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Combustible -->
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0">Combustible</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Consumo del Mes:</strong>
                            <div class="h4 text-danger">${data.fuel.month_consumption || 0} L</div>
                        </div>
                        <div class="mb-3">
                            <strong>Eficiencia Promedio:</strong>
                            <div class="h5 text-success">${data.metrics.avg_efficiency || 0} km/L</div>
                        </div>
                        <div>
                            <strong>Consumo Semanal:</strong>
                            <div class="h6">${data.fuel.week_consumption || 0} L</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rendimiento -->
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">Rendimiento</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Puntaje Promedio:</strong>
                            <div class="h4 text-primary">${data.summary.avg_driver_score || 0}/100</div>
                        </div>
                        <div class="mb-3">
                            <strong>Mejor Eficiencia:</strong>
                            <div class="h5 text-success">${data.summary.best_efficiency || 0} km/L</div>
                        </div>
                        <div>
                            <strong>Rutas del Mes:</strong>
                            <div class="h6">${data.fuel.month_routes || 0}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Top Choferes -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">Top 5 Choferes por Rendimiento</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Pos.</th>
                                        <th>Chofer</th>
                                        <th>Puntaje</th>
                                        <th>Eficiencia</th>
                                    </tr>
                                </thead>
                                <tbody>`;

        data.drivers.forEach((driver, index) => {
            const position = index + 1;
            const medal = position === 1 ? '🥇' : position === 2 ? '🥈' : position === 3 ? '🥉' : position;
            const badgeClass = driver.score >= 85 ? 'bg-success' : driver.score >= 70 ? 'bg-warning' : 'bg-danger';

            content += `
            <tr>
                <td><strong>${medal}</strong></td>
                <td>${driver.driver}</td>
                <td><span class="badge ${badgeClass}">${driver.score}</span></td>
                <td>${driver.efficiency} km/L</td>
            </tr>
        `;
        });

        const finalContent = content + `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top Rutas -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">Rutas Más Utilizadas</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Ruta</th>
                                        <th>Completadas</th>
                                        <th>Consumo Prom.</th>
                                    </tr>
                                </thead>
                                <tbody>`;

        data.routes.forEach(route => {
            finalContent += `
            <tr>
                <td><strong>${route.route}</strong></td>
                <td><span class="badge bg-primary">${route.completions}</span></td>
                <td>${route.avg_consumption} L</td>
            </tr>
        `;
        });

        const completeContent = finalContent + `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Contenido completo del PDF:</strong> El reporte incluirá gráficos detallados, 
                    análisis comparativo por períodos, recomendaciones específicas, tendencias de consumo, 
                    y métricas adicionales no mostradas en esta vista previa.
                </div>
            </div>
        </div>
    `;

        $('#reportPreviewContent').html(completeContent);
    }

    function downloadReport(reportType) {
        currentReportType = reportType;

        // Mostrar indicador de descarga
        const button = $('button[onclick="downloadReport(\'' + reportType + '\')"]');
        const originalText = button.html();
        button.html('<i class="fas fa-spinner fa-spin me-2"></i>Generando PDF...').prop('disabled', true);

        // Crear enlace de descarga
        const downloadUrl = '/coordinator/download_report';

        // Crear elemento temporal para descarga
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.style.display = 'none';
        document.body.appendChild(link);

        // Simular click para iniciar descarga
        link.click();

        // Limpiar
        document.body.removeChild(link);

        // Restaurar botón después de un delay
        setTimeout(() => {
            button.html(originalText).prop('disabled', false);
            showAlert('Reporte de coordinación descargado correctamente', 'success');
        }, 3000);
    }

    // Funciones para opciones adicionales
    function exportToExcel() {
        showAlert('Función de exportación a Excel en desarrollo', 'info');
    }

    function scheduleReport() {
        showAlert('Función de programación de reportes en desarrollo', 'info');
    }

    function shareReport() {
        showAlert('Función de compartir reportes en desarrollo', 'info');
    }

    function generateCustomReport() {
        const period = $('#reportPeriod').val();
        const includeDrivers = $('#includeDrivers').is(':checked');
        const includeRoutes = $('#includeRoutes').is(':checked');
        const includeFuel = $('#includeFuel').is(':checked');
        const includeRecommendations = $('#includeRecommendations').is(':checked');

        // Aquí puedes agregar lógica para generar reportes personalizados
        $('#reportOptionsModal').modal('hide');
        showAlert('Generando reporte personalizado...', 'info');

        // Por ahora, simplemente descargar el reporte normal
        setTimeout(() => {
            downloadReport('coordinator');
        }, 1000);
    }

    // Handler para descargar desde el modal de preview
    $('#downloadFromPreview').click(function () {
        $('#reportPreviewModal').modal('hide');
        downloadReport(currentReportType);
    });

    // Mostrar/ocultar campos de fecha personalizada
    $('#reportPeriod').change(function () {
        if ($(this).val() === 'custom') {
            $('#customPeriodDiv').show();
        } else {
            $('#customPeriodDiv').hide();
        }
    });

    // Limpiar datos cuando se cierre el modal
    $('#reportPreviewModal').on('hidden.bs.modal', function () {
        $('#reportPreviewContent').html(`
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Generando vista previa...</p>
        </div>
    `);
    });

    // Función para mostrar estadísticas en tiempo real
    function updateReportStats() {
        console.log('Actualizando estadísticas para reportes...');
    }

    // Actualizar métricas cada 5 minutos
    setInterval(loadCoordinatorMetrics, 300000);

    // Actualizar stats cada 5 minutos
    setInterval(updateReportStats, 300000);
</script>
{% endblock %}