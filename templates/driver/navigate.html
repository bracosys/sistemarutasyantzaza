{% extends "base.html" %}

{% block title %}Navegando: {{ route.name }} - Sistema de Optimización de Rutas{% endblock %}

{% block page_title %}Navegando: {{ route.name }}{% endblock %}

{% block sidebar_items %}
<li class="nav-item">
    <a href="{{ url_for('driver_dashboard') }}" class="nav-link">
        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
    </a>
</li>
<li class="nav-item">
    <a href="{{ url_for('driver_route_history') }}" class="nav-link">
        <i class="fas fa-history me-2"></i> Historial de rutas
    </a>
</li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Panel de control de navegación -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 bg-success text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-route me-2"></i>Ruta en Progreso
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Ruta:</strong> {{ route.name }}
                </div>

                {% if route.distance %}
                <div class="mb-3">
                    <strong>Distancia:</strong> {{ route.distance|distance_format }}
                </div>
                {% endif %}

                <div class="mb-3">
                    <strong>Iniciada:</strong> {{ completion.started_at|datetime_format }}
                </div>

                {% if completion.vehicle %}
                <div class="mb-3">
                    <strong>Vehículo:</strong> {{ completion.vehicle.brand }} {{ completion.vehicle.model }}<br>
                    <small class="text-muted">Placa: {{ completion.vehicle.plate_number }}</small>
                </div>
                {% endif %}

                {% if completion.fuel_start %}
                <div class="mb-3">
                    <strong>Combustible inicial:</strong>
                    <span class="badge bg-info">{{ completion.fuel_start }}/4</span>
                </div>
                {% endif %}

                <!-- Estado de GPS -->
                <div class="mb-3">
                    <strong>Estado GPS:</strong>
                    <span id="gpsStatus" class="badge bg-secondary">
                        <i class="fas fa-satellite-dish me-1"></i>Desconectado
                    </span>
                    <div id="gpsAccuracy" class="small text-muted mt-1" style="display: none;"></div>
                </div>

                <!-- Posición actual -->
                <div class="mb-3" id="currentPosition" style="display: none;">
                    <strong>Posición actual:</strong><br>
                    <small id="coordinates" class="text-muted"></small>
                    <div id="lastUpdate" class="small text-muted"></div>
                </div>

                <!-- Tiempo transcurrido -->
                <div class="mb-3">
                    <strong>Tiempo transcurrido:</strong>
                    <span id="elapsedTime" class="badge bg-primary">00:00:00</span>
                </div>
            </div>
        </div>

        <!-- Controles de navegación -->
        <div class="card shadow mt-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Controles</h6>
            </div>
            <div class="card-body">
                <!-- Botón para activar/desactivar GPS -->
                <div class="d-grid gap-2 mb-3">
                    <button id="toggleGpsBtn" class="btn btn-outline-primary" type="button">
                        <i class="fas fa-satellite-dish me-2"></i>
                        <span id="gpsButtonText">Activar GPS</span>
                    </button>
                </div>

                <!-- Botones de acción -->
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success" data-bs-toggle="modal"
                        data-bs-target="#completeModal">
                        <i class="fas fa-flag-checkered me-2"></i>Completar Ruta
                    </button>

                    <button type="button" class="btn btn-warning" onclick="pauseNavigation()">
                        <i class="fas fa-pause me-2"></i>Pausar
                    </button>

                    <button type="button" class="btn btn-secondary" onclick="cancelRoute({{ completion.id }})">
                        <i class="fas fa-times me-2"></i>Cancelar Ruta
                    </button>
                </div>

                <!-- Información adicional -->
                <hr>
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    El GPS ayuda a registrar tu progreso automáticamente.
                </small>
            </div>
        </div>

        <!-- Panel de estadísticas en tiempo real -->
        <div class="card shadow mt-3">
            <div class="card-header py-2">
                <h6 class="m-0 font-weight-bold text-info">
                    <i class="fas fa-chart-line me-2"></i>Estadísticas
                </h6>
            </div>
            <div class="card-body p-3">
                <div class="row text-center">
                    <div class="col-6 mb-2">
                        <small class="text-muted">Velocidad</small>
                        <div id="currentSpeed" class="h6 mb-0">0 km/h</div>
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">Distancia</small>
                        <div id="traveledDistance" class="h6 mb-0">0.0 km</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa de navegación -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-map me-2"></i>Mapa de Navegación
                </h6>
            </div>
            <div class="card-body p-0">
                <div style="height: 600px; width: 100%; position: relative;">
                    {{ map_html|safe }}

                    <!-- Overlay para mostrar información -->
                    <div id="navigationOverlay"
                        style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; display: none;">
                        <small>
                            <strong>Tu posición:</strong><br>
                            <span id="overlayCoords"></span><br>
                            <span id="overlayTime"></span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para completar ruta -->
<div class="modal fade" id="completeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Completar Ruta: {{ route.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Ruta iniciada:</strong> {{ completion.started_at|datetime_format }}<br>
                    <strong>Vehículo:</strong> {{ completion.vehicle.brand }} {{ completion.vehicle.model }}<br>
                    <strong>Combustible inicial:</strong> {{ completion.fuel_start }}/4
                </div>

                <div class="mb-3">
                    <label for="fuel_end_level" class="form-label">Nivel Final de Combustible:</label>
                    <div class="fuel-gauge">
                        <div class="fuel-options">
                            <input type="radio" id="fuel_end_1" name="fuel_end_level" value="1" required>
                            <label for="fuel_end_1" class="fuel-label">
                                <div class="fuel-bar">
                                    <div class="fuel-fill fuel-1"></div>
                                </div>
                                <span>1/4</span>
                            </label>

                            <input type="radio" id="fuel_end_2" name="fuel_end_level" value="2" required>
                            <label for="fuel_end_2" class="fuel-label">
                                <div class="fuel-bar">
                                    <div class="fuel-fill fuel-2"></div>
                                </div>
                                <span>2/4</span>
                            </label>

                            <input type="radio" id="fuel_end_3" name="fuel_end_level" value="3" required>
                            <label for="fuel_end_3" class="fuel-label">
                                <div class="fuel-bar">
                                    <div class="fuel-fill fuel-3"></div>
                                </div>
                                <span>3/4</span>
                            </label>

                            <input type="radio" id="fuel_end_4" name="fuel_end_level" value="4" required>
                            <label for="fuel_end_4" class="fuel-label">
                                <div class="fuel-bar">
                                    <div class="fuel-fill fuel-4"></div>
                                </div>
                                <span>4/4</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="completion_notes" class="form-label">Notas del recorrido (opcional):</label>
                    <textarea class="form-control" id="completion_notes" rows="3"
                        placeholder="Observaciones sobre el recorrido, incidentes, condiciones de la ruta, etc."></textarea>
                </div>

                <!-- Resumen del viaje -->
                <div id="tripSummary" class="alert alert-light" style="display: none;">
                    <h6 class="mb-2">Resumen del Viaje:</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Tiempo total</small>
                            <div id="summaryTime">--:--</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Distancia</small>
                            <div id="summaryDistance">-- km</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Velocidad prom.</small>
                            <div id="summarySpeed">-- km/h</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="completeRouteBtn">
                    <i class="fas fa-flag-checkered me-2"></i>Completar Ruta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast para notificaciones -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="gpsToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-satellite-dish text-primary me-2"></i>
            <strong class="me-auto">GPS</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="gpsToastBody">
            <!-- Mensaje dinámico -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para el selector de combustible */
    .fuel-gauge {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #dee2e6;
    }

    .fuel-options {
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: end;
        flex-wrap: nowrap;
    }

    .fuel-label {
        cursor: pointer;
        text-align: center;
        transition: transform 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
        border-radius: 8px;
        min-width: 60px;
    }

    .fuel-label:hover {
        transform: scale(1.05);
        background-color: rgba(0, 123, 255, 0.1);
    }

    .fuel-bar {
        width: 30px;
        height: 60px;
        border: 2px solid #333;
        border-radius: 15px;
        background: #e9ecef;
        position: relative;
        margin-bottom: 8px;
        overflow: hidden;
    }

    .fuel-fill {
        position: absolute;
        bottom: 0;
        width: 100%;
        transition: all 0.3s ease;
    }

    .fuel-1 {
        height: 25%;
        background: linear-gradient(180deg, #dc3545 0%, #c82333 100%);
        border-radius: 0 0 13px 13px;
    }

    .fuel-2 {
        height: 50%;
        background: linear-gradient(180deg, #fd7e14 0%, #e8670e 100%);
        border-radius: 0 0 13px 13px;
    }

    .fuel-3 {
        height: 75%;
        background: linear-gradient(180deg, #ffc107 0%, #e0a800 100%);
        border-radius: 0 0 13px 13px;
    }

    .fuel-4 {
        height: 100%;
        background: linear-gradient(180deg, #28a745 0%, #1e7e34 100%);
        border-radius: 13px;
    }

    input[type="radio"] {
        display: none;
    }

    input[type="radio"]:checked+.fuel-label {
        transform: scale(1.1);
        background-color: rgba(0, 123, 255, 0.2);
    }

    input[type="radio"]:checked+.fuel-label .fuel-bar {
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.6);
        border-color: #007bff;
    }

    input[type="radio"]:checked+.fuel-label span {
        font-weight: bold;
        color: #007bff;
    }

    .fuel-label span {
        font-size: 0.9rem;
        color: #6c757d;
        transition: all 0.3s ease;
    }

    /* Estilos para el estado GPS */
    .badge {
        font-size: 0.8em;
    }

    #navigationOverlay {
        backdrop-filter: blur(5px);
        max-width: 200px;
    }

    /* Indicador de precisión GPS */
    #gpsAccuracy {
        font-size: 0.75rem;
    }

    /* Animación para el estado activo del GPS */
    .gps-active {
        animation: pulse-gps 2s infinite;
    }

    @keyframes pulse-gps {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }

        100% {
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let gpsActive = false;
    let gpsWatchId = null;
    let lastPosition = null;
    let startTime = new Date('{{ completion.started_at.isoformat() }}');
    let elapsedInterval = null;
    let traveledDistance = 0;
    let previousPosition = null;

    // Variables para tracking
    let trackingPoints = [];
    let lastTrackingUpdate = null;

    $(document).ready(function () {
        console.log('=== NAVIGATION DEBUG ===');
        console.log('Route ID:', '{{ route.id }}');
        console.log('Route name:', '{{ route.name }}');
        console.log('Completion ID:', '{{ completion.id }}');
        console.log('Map source:', '{{ map_source | default("unknown") }}');

        // Verificar si el mapa se cargó
        const mapContent = $('body').html();
        const hasLeafletMap = mapContent.includes('leaflet') || mapContent.includes('L.map');
        const hasFoliumMap = mapContent.includes('folium') || mapContent.includes('openstreetmap');

        console.log('Has Leaflet map:', hasLeafletMap);
        console.log('Has Folium map:', hasFoliumMap);

        if (!hasFoliumMap && !hasLeafletMap) {
            console.warn('⚠️ NO MAP DETECTED - Possible issues:');
            console.warn('1. Route file_path not found');
            console.warn('2. Map file corrupted or empty');
            console.warn('3. Backend error loading map');

            showAlert('No se pudo cargar el mapa de la ruta. El sistema usará fallback.', 'warning');
        } else {
            console.log('✅ Map loaded successfully');
        }

        console.log('========================');

        // Inicializar contador de tiempo
        startElapsedTimer();

        // Handler para activar/desactivar GPS
        $('#toggleGpsBtn').on('click', function () {
            if (gpsActive) {
                stopGPS();
            } else {
                startGPS();
            }
        });

        // Handler para completar ruta
        $('#completeRouteBtn').on('click', function (e) {
            e.preventDefault();
            completeRoute();
        });

        // Verificar soporte de geolocalización
        if (!navigator.geolocation) {
            showAlert('Tu navegador no soporta geolocalización', 'warning');
            $('#toggleGpsBtn').prop('disabled', true).html('<i class="fas fa-exclamation-triangle me-2"></i>GPS No Disponible');
        }

        // Configurar modal de completar ruta
        $('#completeModal').on('show.bs.modal', function () {
            updateTripSummary();
        });
    });

    function startElapsedTimer() {
        elapsedInterval = setInterval(updateElapsedTime, 1000);
        updateElapsedTime(); // Actualizar inmediatamente
    }

    function updateElapsedTime() {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);

        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;

        const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        $('#elapsedTime').text(timeString);
    }

    function startGPS() {
        if (!navigator.geolocation) {
            showAlert('Geolocalización no disponible', 'error');
            return;
        }

        const options = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 30000
        };

        showAlert('Activando GPS...', 'info');

        gpsWatchId = navigator.geolocation.watchPosition(
            onGPSSuccess,
            onGPSError,
            options
        );

        gpsActive = true;
        updateGPSUI();
    }

    function stopGPS() {
        if (gpsWatchId !== null) {
            navigator.geolocation.clearWatch(gpsWatchId);
            gpsWatchId = null;
        }

        gpsActive = false;
        updateGPSUI();
        showAlert('GPS desactivado', 'info');

        // Ocultar elementos relacionados con GPS
        $('#currentPosition').hide();
        $('#navigationOverlay').hide();
    }

    function onGPSSuccess(position) {
        const coords = position.coords;
        lastPosition = {
            lat: coords.latitude,
            lng: coords.longitude,
            accuracy: coords.accuracy,
            speed: coords.speed || 0,
            heading: coords.heading || 0,
            timestamp: new Date()
        };

        console.log('GPS position updated:', lastPosition);

        // Calcular distancia recorrida
        if (previousPosition) {
            const distance = calculateDistance(
                previousPosition.lat, previousPosition.lng,
                lastPosition.lat, lastPosition.lng
            );

            // Solo sumar si la distancia es razonable (menos de 100m por segundo)
            if (distance < 0.1) {
                traveledDistance += distance;
            }
        }

        previousPosition = lastPosition;

        // Actualizar UI
        updatePositionDisplay(lastPosition);
        updateStatistics(lastPosition);

        // Enviar al servidor (cada 30 segundos para no sobrecargar)
        const now = Date.now();
        if (!lastTrackingUpdate || (now - lastTrackingUpdate) > 30000) {
            sendPositionUpdate(lastPosition);
            lastTrackingUpdate = now;
        }

        // Almacenar punto para el tracking
        trackingPoints.push({
            lat: lastPosition.lat,
            lng: lastPosition.lng,
            timestamp: lastPosition.timestamp.toISOString(),
            speed: lastPosition.speed,
            accuracy: lastPosition.accuracy
        });
    }

    function onGPSError(error) {
        let errorMessage = 'Error de GPS';

        switch (error.code) {
            case error.PERMISSION_DENIED:
                errorMessage = 'Permiso de ubicación denegado';
                break;
            case error.POSITION_UNAVAILABLE:
                errorMessage = 'Ubicación no disponible';
                break;
            case error.TIMEOUT:
                errorMessage = 'Timeout de GPS';
                break;
        }

        console.error('GPS Error:', error);
        $('#gpsStatus').removeClass('bg-success gps-active').addClass('bg-danger').html('<i class="fas fa-exclamation-triangle me-1"></i>Error GPS');
        showAlert(errorMessage, 'error');
    }

    function updateGPSUI() {
        const btn = $('#toggleGpsBtn');
        const status = $('#gpsStatus');
        const buttonText = $('#gpsButtonText');

        if (gpsActive) {
            btn.removeClass('btn-outline-primary').addClass('btn-outline-danger');
            buttonText.text('Desactivar GPS');
            status.removeClass('bg-secondary bg-danger').addClass('bg-success gps-active')
                .html('<i class="fas fa-satellite-dish me-1"></i>GPS Activo');
        } else {
            btn.removeClass('btn-outline-danger').addClass('btn-outline-primary');
            buttonText.text('Activar GPS');
            status.removeClass('bg-success bg-danger gps-active').addClass('bg-secondary')
                .html('<i class="fas fa-satellite-dish me-1"></i>GPS Inactivo');
        }
    }

    function updatePositionDisplay(position) {
        const coordsText = `${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`;
        const timeText = position.timestamp.toLocaleTimeString();
        const accuracyText = `±${Math.round(position.accuracy)}m`;

        $('#coordinates').html(`${coordsText}<br><small class="text-muted">${accuracyText}</small>`);
        $('#lastUpdate').text(`Actualizado: ${timeText}`);
        $('#overlayCoords').text(coordsText);
        $('#overlayTime').text(timeText);

        $('#gpsAccuracy').text(accuracyText).show();
        $('#currentPosition').show();
        $('#navigationOverlay').show();
    }

    function updateStatistics(position) {
        // Actualizar velocidad
        const speedKmh = (position.speed || 0) * 3.6; // m/s a km/h
        $('#currentSpeed').text(`${speedKmh.toFixed(1)} km/h`);

        // Actualizar distancia recorrida
        $('#traveledDistance').text(`${traveledDistance.toFixed(1)} km`);
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Radio de la Tierra en km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function sendPositionUpdate(position) {
        if (!gpsActive) return;

        const data = {
            position: {
                lat: position.lat,
                lng: position.lng,
                accuracy: position.accuracy,
                speed: position.speed,
                heading: position.heading,
                timestamp: position.timestamp.toISOString()
            }
        };

        makeRequest('/driver/update_route_progress/{{ completion.id }}', data,
            function (response) {
                console.log('Position sent successfully');
            },
            function (error) {
                console.error('Error sending position:', error);
            }
        );
    }

    function pauseNavigation() {
        if (gpsActive) {
            stopGPS();
            showAlert('Navegación pausada', 'info');
        } else {
            showAlert('La navegación ya está pausada', 'warning');
        }
    }

    function updateTripSummary() {
        // Calcular tiempo total
        const now = new Date();
        const totalTime = Math.floor((now - startTime) / 1000);
        const hours = Math.floor(totalTime / 3600);
        const minutes = Math.floor((totalTime % 3600) / 60);

        $('#summaryTime').text(`${hours}h ${minutes}m`);
        $('#summaryDistance').text(`${traveledDistance.toFixed(1)} km`);

        // Calcular velocidad promedio
        const avgSpeed = totalTime > 0 ? (traveledDistance / (totalTime / 3600)) : 0;
        $('#summarySpeed').text(`${avgSpeed.toFixed(1)} km/h`);

        $('#tripSummary').show();
    }

    function completeRoute() {
        const fuelLevel = $('input[name="fuel_end_level"]:checked').val();
        const notes = $('#completion_notes').val().trim();

        if (!fuelLevel) {
            showAlert('Selecciona el nivel de combustible', 'warning');
            return;
        }

        if (!confirm(`¿Completar ruta con combustible ${fuelLevel}/4?`)) {
            return;
        }

        const button = $('#completeRouteBtn');
        const originalText = button.html();
        button.html('<span class="spinner-border spinner-border-sm me-2"></span>Completando...').prop('disabled', true);

        const requestData = {
            fuel_level: parseInt(fuelLevel),
            notes: notes,
            final_position: lastPosition,
            trip_summary: {
                total_time: Math.floor((new Date() - startTime) / 1000),
                traveled_distance: traveledDistance,
                tracking_points: trackingPoints
            }
        };

        makeRequest('/driver/complete_route/{{ completion.id }}', requestData,
            function (response) {
                if (gpsActive) stopGPS();

                // Detener timer
                if (elapsedInterval) {
                    clearInterval(elapsedInterval);
                }

                showAlert(response.message || 'Ruta completada exitosamente', 'success');
                $('#completeModal').modal('hide');

                setTimeout(() => {
                    window.location.href = '/driver/dashboard';
                }, 2000);
            },
            function (errorMessage) {
                showAlert(errorMessage, 'error');
                button.html(originalText).prop('disabled', false);
            }
        );
    }

    function cancelRoute(completionId) {
        const reason = prompt('¿Por qué cancelas la ruta?');

        if (reason !== null && reason.trim() !== '') {
            if (gpsActive) stopGPS();

            // Detener timer
            if (elapsedInterval) {
                clearInterval(elapsedInterval);
            }

            const requestData = {
                reason: reason.trim(),
                final_position: lastPosition,
                trip_summary: {
                    total_time: Math.floor((new Date() - startTime) / 1000),
                    traveled_distance: traveledDistance,
                    tracking_points: trackingPoints
                }
            };

            makeRequest(`/driver/cancel_route/${completionId}`, requestData,
                function (response) {
                    showAlert(response.message || 'Ruta cancelada', 'success');
                    setTimeout(() => {
                        window.location.href = '/driver/dashboard';
                    }, 2000);
                },
                function (errorMessage) {
                    showAlert(errorMessage, 'error');
                }
            );
        }
    }

    function showAlert(message, type = 'info', persistent = false) {
        const colors = {
            success: 'alert-success',
            info: 'alert-info',
            warning: 'alert-warning',
            error: 'alert-danger',
            danger: 'alert-danger'
        };

        const iconMap = {
            success: 'fas fa-check-circle',
            info: 'fas fa-info-circle',
            warning: 'fas fa-exclamation-triangle',
            error: 'fas fa-exclamation-circle',
            danger: 'fas fa-exclamation-circle'
        };

        const alertHtml = `
        <div class="alert ${colors[type]} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
            <i class="${iconMap[type]} me-2"></i>
            ${message}
            ${!persistent ? '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' : ''}
        </div>
    `;

        $('body').append(alertHtml);

        if (!persistent) {
            setTimeout(() => {
                $('.alert').last().fadeOut(() => {
                    $('.alert').last().remove();
                });
            }, 5000);
        }
    }

    function makeRequest(url, data, successCallback, errorCallback) {
        console.log('Making request to:', url);
        console.log('Request data:', data);

        $.ajax({
            url: url,
            method: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            timeout: 15000,
            beforeSend: function (xhr) {
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            },
            success: function (response) {
                console.log('Request successful:', response);
                if (typeof successCallback === 'function') {
                    successCallback(response);
                }
            },
            error: function (xhr, status, error) {
                console.error('Request failed:', {
                    url: url,
                    status: xhr.status,
                    statusText: xhr.statusText,
                    error: error,
                    responseText: xhr.responseText
                });

                let errorMessage = 'Error de conexión';

                if (xhr.status === 0) {
                    errorMessage = 'Sin conexión a internet';
                } else if (xhr.status === 404) {
                    errorMessage = 'Recurso no encontrado (404)';
                } else if (xhr.status === 500) {
                    errorMessage = 'Error interno del servidor (500)';
                } else if (status === 'timeout') {
                    errorMessage = 'Tiempo de espera agotado';
                } else {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.error || response.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Error ${xhr.status}: ${xhr.statusText}`;
                    }
                }

                if (typeof errorCallback === 'function') {
                    errorCallback(errorMessage);
                } else {
                    showAlert(errorMessage, 'error');
                }
            }
        });
    }

    // Limpiar recursos al salir
    window.addEventListener('beforeunload', function () {
        if (gpsActive) {
            stopGPS();
        }
        if (elapsedInterval) {
            clearInterval(elapsedInterval);
        }
    });
</script>
{% endblock %}