{% extends "base.html" %}

{% block sidebar_items %}
<li class="nav-item">
    <a href="{{ url_for('admin_dashboard') }}" class="nav-link">
        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
    </a>
</li>
<li class="nav-item">
    <a href="{{ url_for('manage_users') }}" class="nav-link active">
        <i class="fas fa-users me-2"></i> Usuarios
    </a>
</li>
<li class="nav-item">
    <a href="{{ url_for('manage_routes') }}" class="nav-link">
        <i class="fas fa-route me-2"></i> Rutas
    </a>
</li>
<li class="nav-item">
    <a href="{{ url_for('manage_vehicles') }}" class="nav-link">
        <i class="fas fa-truck me-2"></i> Vehículos
    </a>
</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Crear Nueva Ruta</h3>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="routeForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="route_name">Nombre de la Ruta *</label>
                                    <input type="text" class="form-control" id="route_name" name="route_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="optimization_level">Nivel de Optimización</label>
                                    <select class="form-control" id="optimization_level" name="optimization_level">
                                        <option value="basic">Básico - Optimización rápida</option>
                                        <option value="medium" selected>Medio - Equilibrio entre calidad y velocidad
                                        </option>
                                        <option value="advanced">Avanzado - Máxima optimización</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="route_description">Descripción</label>
                            <textarea class="form-control" id="route_description" name="route_description" rows="3"
                                placeholder="Descripción opcional de la ruta"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="gpx_files">Archivos GPX *</label>
                            <input type="file" class="form-control-file" id="gpx_files" name="gpx_files" multiple
                                accept=".gpx" required>
                            <small class="form-text text-muted">
                                Selecciona uno o más archivos GPX. Los archivos serán optimizados y combinados en una
                                sola ruta.
                            </small>
                            <div id="file-info" class="mt-2"></div>
                        </div>

                        <div class="form-group">
                            <div class="alert alert-info">
                                <h5>Niveles de Optimización:</h5>
                                <ul class="mb-0">
                                    <li><strong>Básico:</strong> Elimina bucles básicos y simplifica la ruta</li>
                                    <li><strong>Medio:</strong> Optimización balanceada con suavizado de trayectoria
                                    </li>
                                    <li><strong>Avanzado:</strong> Máxima optimización con eliminación de puntos
                                        redundantes</li>
                                </ul>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-success" id="submitBtn">
                                <i class="fas fa-save"></i> Crear Ruta
                            </button>
                            <a href="{{ url_for('manage_routes') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                        </div>
                    </form>

                    <!-- Progress indicator -->
                    <div id="progress-container" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <h5>Procesando ruta...</h5>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                    style="width: 100%"></div>
                            </div>
                            <p class="mt-2 mb-0">
                                <small>Esto puede tomar unos minutos dependiendo del tamaño de los archivos GPX y el
                                    nivel de optimización seleccionado.</small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        const fileInput = document.getElementById('gpx_files');
        const submitBtn = document.getElementById('submitBtn');
        const progressContainer = document.getElementById('progress-container');

        // Show file information when files are selected
        fileInput.addEventListener('change', function () {
            const files = Array.from(this.files);

            // Validate file types and show info
            let validFiles = 0;
            let totalSize = 0;

            files.forEach(file => {
                if (file.name.toLowerCase().endsWith('.gpx')) {
                    validFiles++;
                    totalSize += file.size;
                }
            });

            // Create or update file info display
            let fileInfoDiv = document.getElementById('file-info');
            if (!fileInfoDiv) {
                fileInfoDiv = document.createElement('div');
                fileInfoDiv.id = 'file-info';
                fileInfoDiv.className = 'mt-2';
                fileInput.parentNode.appendChild(fileInfoDiv);
            }

            if (validFiles > 0) {
                const totalSizeKB = (totalSize / 1024).toFixed(1);
                let infoHtml = `<div class="alert alert-success"><small>
                <strong>✓ ${validFiles} archivo(s) GPX válido(s) seleccionado(s)</strong><br>
                Tamaño total: ${totalSizeKB} KB
            </small></div>`;

                if (validFiles !== files.length) {
                    infoHtml += `<div class="alert alert-warning"><small>
                    <strong>⚠ Algunos archivos fueron ignorados</strong><br>
                    Solo se procesarán los archivos con extensión .gpx
                </small></div>`;
                }

                fileInfoDiv.innerHTML = infoHtml;
            } else if (files.length > 0) {
                fileInfoDiv.innerHTML = `<div class="alert alert-danger"><small>
                <strong>✗ No se seleccionaron archivos GPX válidos</strong><br>
                Por favor, selecciona archivos con extensión .gpx
            </small></div>`;
            } else {
                fileInfoDiv.innerHTML = '';
            }
        });

        // Handle form submission
        form.addEventListener('submit', function (e) {
            const files = Array.from(fileInput.files);
            const routeName = document.getElementById('route_name').value.trim();

            // Validate form
            if (!routeName) {
                alert('Por favor ingresa un nombre para la ruta.');
                e.preventDefault();
                return;
            }

            if (files.length === 0) {
                alert('Por favor selecciona al menos un archivo GPX.');
                e.preventDefault();
                return;
            }

            // Check file types
            const validFiles = files.filter(file => file.name.toLowerCase().endsWith('.gpx'));
            if (validFiles.length === 0) {
                alert('Solo se permiten archivos con extensión .gpx');
                e.preventDefault();
                return;
            }

            // Show progress and disable form
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando Ruta...';
            progressContainer.style.display = 'block';

            // Scroll to progress indicator
            progressContainer.scrollIntoView({ behavior: 'smooth' });

            // Add timestamp for debugging
            console.log('Formulario enviado:', new Date().toISOString());
            console.log('Nombre de ruta:', routeName);
            console.log('Archivos GPX válidos:', validFiles.map(f => f.name));
            console.log('Nivel de optimización:', document.getElementById('optimization_level').value);
        });

        // Prevent double submission
        let formSubmitted = false;
        form.addEventListener('submit', function (e) {
            if (formSubmitted) {
                e.preventDefault();
                return;
            }
            formSubmitted = true;
        });
    });
</script>
{% endblock %}